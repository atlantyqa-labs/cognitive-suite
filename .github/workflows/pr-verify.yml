name: PR Verify (Full)

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: pr-verify-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Sanity checks
        run: |
          set -euo pipefail
          test -f docs/portal/lab-01-deep-dive.md
          test -f docs/portal/lab-02-gitops-steward.md
          test -f docs/portal/lab-03-bootstrap-dashboard.md
          test -f docs/portal/talent-challenge-labs.md

  python-compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Compile Python sources
        run: |
          python -m compileall -q cogctl.py ingestor pipeline frontend scripts

  docs-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements-docs.txt
      - name: Install docs deps
        run: |
          pip install -r requirements-docs.txt
      - name: Build docs (strict)
        run: |
          mkdocs build --strict --config-file mkdocs.public.yml --site-dir site-public
          mkdocs build --strict --config-file mkdocs.yml --site-dir site-internal

  compose-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compose config sanity
        run: |
          docker compose -f docker-compose.yml config -q || true
          docker compose -f docker-compose.prod.yml config -q || true

  approval-gate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Require 2 approvals
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_SLUG: ${{ github.repository }}
          REQUIRED_APPROVALS: "2"
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "GITHUB_TOKEN not available" >&2
            exit 1
          fi
          approvals=$(curl -sS -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO_SLUG}/pulls/${PR_NUMBER}/reviews?per_page=100" \
            | jq -r '[.[] | select(.state=="APPROVED") | .user.login] | unique | length')
          if [ "${approvals}" -lt "${REQUIRED_APPROVALS}" ]; then
            echo "Need ${REQUIRED_APPROVALS} approvals; got ${approvals}" >&2
            exit 1
          fi
