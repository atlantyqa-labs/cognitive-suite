name: CI Docs (MkDocs)

on:
  workflow_call:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  institutional-uat:
    name: Institutional UAT (knowledge + narrative contracts)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: |
            requirements-ci.txt
            requirements-docs.txt

      - name: Install validation deps
        run: |
          python3 -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            python3 -m pip install -r requirements-ci.txt
          fi
          if [ -f requirements-docs.txt ]; then
            python3 -m pip install -r requirements-docs.txt
          fi

      - name: Validate knowledge schemas and datasets
        run: |
          python3 scripts/validate-knowledge.py

      - name: Validate stakeholder intake coherence
        run: |
          python3 scripts/validate-stakeholder-intake.py

      - name: Validate view contracts and ontology bindings
        run: |
          python3 scripts/validate-knowledge-uat.py \
            --output outputs/ci-evidence/knowledge-uat-report.json

      - name: Upload institutional UAT evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: institutional-uat-evidence
          path: outputs/ci-evidence
          if-no-files-found: error

  build:
    needs: institutional-uat
    name: Docs Build (strict)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements-docs.txt

      - name: Install docs deps
        run: |
          pip install -r requirements-docs.txt

      - name: Build docs (strict)
        run: |
          mkdocs build --strict --config-file mkdocs.public.yml --site-dir site-public
          mkdocs build --strict --config-file mkdocs.yml --site-dir site-internal

      - name: Upload docs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-site-public
          path: site-public
          if-no-files-found: error

      - name: Upload internal docs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-site-internal
          path: site-internal
          if-no-files-found: error

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site-public

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4
